import krpc
from time import sleep

def monitor(vessel):
    """
    Функция, предназначенная для запуска в отдельном потоке.
    Постоянно отслеживает количество топлива (жидкого и твердого) в текущей ступени.
    Когда топливо заканчивается, автоматически активирует следующую ступень.
    """

    # Небольшая задержка перед началом мониторинга,
    # чтобы дать основному скрипту время на инициализацию и старт.
    sleep(3)

    # Бесконечный цикл мониторинга (поток работает всё время полёта)
    while True:
        # Получаем объект ресурсов для ступени, которая должна быть сброшена следующей.
        # vessel.control.current_stage — номер текущей активной ступени (индексация с 0).
        # При стандартном управлении ступени нумеруются так, что последняя (верхняя) имеет номер 0,
        # а первая (нижняя) — максимальный номер. В KSP ступени срабатывают в обратном порядке:
        # нажатие пробела активирует ступень с наибольшим номером.
        # Здесь используется current_stage - 1, потому что после активации ступени current_stage уменьшается.
        # Подробнее: в момент проверки current_stage указывает на ступень, которая сейчас активна,
        # а ресурсы мы хотим проверить в ступени, которая должна отделиться после выработки топлива.
        resources = vessel.resources_in_decouple_stage(vessel.control.current_stage - 1, False)

        # Проверяем количество твердого и жидкого топлива в этой ступени
        solidFuel = resources.amount("SolidFuel")
        liquidFuel = resources.amount("LiquidFuel")

        # Если оба типа топлива равны нулю, значит ступень пуста.
        # Это условие подходит и для твердотопливных ускорителей (твердое топливо),
        # и для жидкостных ступеней (жидкое топливо+окислитель учитываются вместе как LiquidFuel).
        if solidFuel == 0 and liquidFuel == 0:
            # Активируем следующую ступень (отделяем пустую и включаем двигатели следующей)
            vessel.control.activate_next_stage()
            print()
            print("Stage decoupled!")
            print()

        # Небольшая пауза, чтобы не нагружать процессор частыми проверками
        sleep(0.2)